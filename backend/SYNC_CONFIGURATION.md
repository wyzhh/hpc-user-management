# LDAP同步配置说明

## 🔄 同步时机

### 1. **启动时立即同步**
- ⏰ **执行时间**: 项目启动后1秒
- 🎯 **执行条件**: 默认总是执行（除非设置 `SYNC_ON_STARTUP=false`）
- 📊 **同步类型**: 完全同步

### 2. **定时增量同步**
- ⏰ **执行频率**: 每10分钟
- 🔄 **Cron表达式**: `*/10 * * * *`
- 📊 **同步类型**: 增量同步
- 🚀 **自动启动**: 是

### 3. **定时完全同步**
- ⏰ **执行时间**: 每天凌晨2点
- 🔄 **Cron表达式**: `0 2 * * *`
- 📊 **同步类型**: 完全同步
- 🚀 **自动启动**: 是

### 4. **手动同步**
- 🖱️ **触发方式**: 用户管理界面按钮
- 📊 **同步类型**: 完全同步或增量同步
- ⚡ **执行时机**: 立即执行

## ⚙️ 环境变量配置

### 启动时同步控制
```bash
# 强制启动时同步（默认行为）
SYNC_ON_STARTUP=true

# 禁用启动时同步
SYNC_ON_STARTUP=false

# 不设置该变量时，默认启动时同步
```

## 📋 同步策略详情

### **完全同步**
1. 从LDAP获取所有PI用户和学生用户
2. 与数据库进行比对
3. 创建新用户、更新现有用户、标记删除用户
4. 记录详细的同步结果和审计日志

### **增量同步**
1. 基于上次同步时间获取变更
2. 当前实现为完全同步（LDAP不支持时间戳查询）
3. 频率较高，确保数据实时性

## 🚀 启动流程

```
项目启动
    ↓
数据库连接测试
    ↓
LDAP连接测试
    ↓
启动定时任务调度器
    ↓
延迟1秒 → 执行启动同步
    ↓
系统正常运行
    ↓ (每10分钟)
执行增量同步
    ↓ (每天凌晨2点)
执行完全同步
```

## 📊 同步结果

每次同步会返回详细结果：

```json
{
  "pis": {
    "total": 50,
    "created": 5,
    "updated": 10,
    "deactivated": 2
  },
  "students": {
    "total": 200,
    "created": 15,
    "updated": 25,
    "deleted": 3
  },
  "errors": []
}
```

## 🛠️ 调试和监控

### 查看同步日志
```bash
# 查看应用日志
docker logs hpc-backend

# 关键日志标识
# 🔄 - 同步开始
# ✅ - 同步成功
# ❌ - 同步失败
# 📊 - 同步统计
```

### 手动触发同步
1. 登录管理员账户
2. 进入"用户管理"页面
3. 点击"完全同步LDAP"或"增量同步"按钮
4. 查看同步结果对话框

## ⚠️ 注意事项

1. **启动时同步**会增加系统启动时间，但确保数据一致性
2. **每10分钟的增量同步**确保数据实时性，但会增加LDAP服务器负载
3. **完全同步**比增量同步更耗时，但数据一致性更好
4. **测试环境**(`NODE_ENV=test`)不会执行任何定时同步

## 🔧 自定义配置

如果需要调整同步频率，修改以下文件：

```typescript
// src/services/scheduler.ts

// 修改增量同步频率（当前：每10分钟）
cron.schedule('*/10 * * * *', async () => {
  // 改为每5分钟：'*/5 * * * *'
  // 改为每30分钟：'*/30 * * * *'
  // 改为每小时：'0 * * * *'
});

// 修改完全同步时间（当前：每天凌晨2点）
cron.schedule('0 2 * * *', async () => {
  // 改为凌晨3点：'0 3 * * *'
  // 改为每12小时：'0 */12 * * *'
});
```