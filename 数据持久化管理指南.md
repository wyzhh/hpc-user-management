# Docker数据持久化管理指南

## 📋 概述

本指南说明如何在Docker容器停止/重启后保持数据表的持久化，包括PostgreSQL数据库和LDAP目录服务的数据保护。

## ✅ 当前持久化配置

### 1. **数据卷配置** (docker-compose.yml)
```yaml
volumes:
  postgres_data:
    driver: local      # PostgreSQL数据持久化
  ldap_data:
    driver: local      # LDAP数据持久化  
  ldap_config:
    driver: local      # LDAP配置持久化
```

### 2. **容器挂载配置**
```yaml
# PostgreSQL容器
db:
  volumes:
    - postgres_data:/var/lib/postgresql/data          # 数据库文件
    - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql  # 初始化脚本

# LDAP容器  
ldap:
  volumes:
    - ldap_data:/var/lib/ldap                         # LDAP数据文件
    - ldap_config:/etc/ldap/slapd.d                   # LDAP配置文件
    - ./database/ldap-init.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/init.ldif
```

## 🔍 验证数据持久化

### 1. **检查数据卷状态**
```bash
# 查看所有数据卷
docker volume ls | grep hpc

# 检查PostgreSQL数据卷详情
docker volume inspect hpc-user-management_postgres_data

# 检查LDAP数据卷详情  
docker volume inspect hpc-user-management_ldap_data
```

### 2. **查看数据卷存储位置**
```bash
# PostgreSQL数据位置
sudo ls -la /var/lib/docker/volumes/hpc-user-management_postgres_data/_data/

# LDAP数据位置
sudo ls -la /var/lib/docker/volumes/hpc-user-management_ldap_data/_data/

# LDAP配置位置
sudo ls -la /var/lib/docker/volumes/hpc-user-management_ldap_config/_data/
```

### 3. **测试持久化功能**
```bash
# 1. 记录当前数据
docker exec hpc-postgres psql -U user -d hpc_management -c "SELECT COUNT(*) FROM pis;"
docker exec hpc-ldap ldapsearch -x -H ldap://localhost:389 -D "cn=admin,dc=hpc,dc=university,dc=edu" -w admin_password -b "dc=hpc,dc=university,dc=edu" "(objectClass=person)" | grep "numEntries"

# 2. 停止容器
docker-compose stop db ldap

# 3. 启动容器
docker-compose up -d db ldap

# 4. 验证数据是否保持
docker exec hpc-postgres psql -U user -d hpc_management -c "SELECT COUNT(*) FROM pis;"
```

## 🛠️ 数据管理操作

### 1. **备份数据**

#### PostgreSQL备份
```bash
# 创建备份目录
mkdir -p ./backups

# 备份数据库
docker exec hpc-postgres pg_dump -U user -d hpc_management > ./backups/hpc_database_$(date +%Y%m%d_%H%M%S).sql

# 备份数据卷
sudo tar -czf ./backups/postgres_volume_$(date +%Y%m%d_%H%M%S).tar.gz -C /var/lib/docker/volumes/hpc-user-management_postgres_data _data
```

#### LDAP备份
```bash
# 备份LDAP数据
docker exec hpc-ldap slapcat > ./backups/ldap_data_$(date +%Y%m%d_%H%M%S).ldif

# 备份LDAP数据卷
sudo tar -czf ./backups/ldap_volume_$(date +%Y%m%d_%H%M%S).tar.gz -C /var/lib/docker/volumes/hpc-user-management_ldap_data _data
```

### 2. **恢复数据**

#### PostgreSQL恢复
```bash
# 从SQL文件恢复
docker exec -i hpc-postgres psql -U user -d hpc_management < ./backups/hpc_database_YYYYMMDD_HHMMSS.sql

# 从数据卷恢复
docker-compose stop db
sudo rm -rf /var/lib/docker/volumes/hpc-user-management_postgres_data/_data/*
sudo tar -xzf ./backups/postgres_volume_YYYYMMDD_HHMMSS.tar.gz -C /var/lib/docker/volumes/hpc-user-management_postgres_data/
docker-compose up -d db
```

#### LDAP恢复
```bash
# 从LDIF文件恢复
docker exec hpc-ldap slapadd -c -l /path/to/backup.ldif

# 从数据卷恢复
docker-compose stop ldap
sudo rm -rf /var/lib/docker/volumes/hpc-user-management_ldap_data/_data/*
sudo tar -xzf ./backups/ldap_volume_YYYYMMDD_HHMMSS.tar.gz -C /var/lib/docker/volumes/hpc-user-management_ldap_data/
docker-compose up -d ldap
```

### 3. **清理和重置**

#### 完全重置数据
```bash
# 停止所有容器
docker-compose down

# 删除数据卷（谨慎操作！）
docker volume rm hpc-user-management_postgres_data
docker volume rm hpc-user-management_ldap_data
docker volume rm hpc-user-management_ldap_config

# 重新创建并初始化
docker-compose up -d
```

#### 仅重置特定服务
```bash
# 重置PostgreSQL
docker-compose stop db
docker volume rm hpc-user-management_postgres_data
docker-compose up -d db

# 重置LDAP
docker-compose stop ldap  
docker volume rm hpc-user-management_ldap_data hpc-user-management_ldap_config
docker-compose up -d ldap
```

## 📊 数据卷状态监控

### 1. **查看数据卷使用情况**
```bash
# 查看数据卷大小
docker system df -v

# 查看特定数据卷大小
sudo du -sh /var/lib/docker/volumes/hpc-user-management_postgres_data/_data
sudo du -sh /var/lib/docker/volumes/hpc-user-management_ldap_data/_data
```

### 2. **监控数据卷健康状态**
```bash
# 检查PostgreSQL数据完整性
docker exec hpc-postgres pg_isready -U user -d hpc_management

# 检查LDAP服务状态
docker exec hpc-ldap ldapsearch -x -H ldap://localhost:389 -s base -b "" "(objectclass=*)" namingContexts
```

## 🔧 高级配置

### 1. **使用外部存储路径**

如果要将数据存储在特定目录，可以修改docker-compose.yml：

```yaml
services:
  db:
    volumes:
      - ./data/postgres:/var/lib/postgresql/data  # 使用本地路径
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql

  ldap:
    volumes:
      - ./data/ldap:/var/lib/ldap                 # 使用本地路径
      - ./data/ldap-config:/etc/ldap/slapd.d      # 使用本地路径
```

### 2. **设置数据卷权限**
```bash
# 创建数据目录
mkdir -p ./data/{postgres,ldap,ldap-config}

# 设置正确的权限
sudo chown -R 999:999 ./data/postgres      # PostgreSQL用户
sudo chown -R 911:911 ./data/ldap          # LDAP用户  
sudo chown -R 911:911 ./data/ldap-config   # LDAP配置
```

### 3. **数据卷备份策略**

#### 自动备份脚本
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="./backups/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# PostgreSQL备份
echo "备份PostgreSQL数据..."
docker exec hpc-postgres pg_dump -U user -d hpc_management > $BACKUP_DIR/postgres.sql

# LDAP备份
echo "备份LDAP数据..."  
docker exec hpc-ldap slapcat > $BACKUP_DIR/ldap.ldif

# 压缩备份
echo "压缩备份文件..."
tar -czf $BACKUP_DIR.tar.gz -C $BACKUP_DIR .
rm -rf $BACKUP_DIR

echo "备份完成: $BACKUP_DIR.tar.gz"
```

#### 设置定时备份
```bash
# 添加到crontab (每天凌晨2点备份)
echo "0 2 * * * /path/to/hpc-user-management/backup.sh" | crontab -
```

## ⚠️ 注意事项

### 1. **数据安全**
- 定期备份数据卷
- 备份文件应存储在不同的物理位置
- 测试恢复流程的有效性

### 2. **权限管理**
- 确保数据卷有正确的文件权限
- 避免使用root权限运行容器
- 定期检查数据目录权限

### 3. **存储空间**
- 监控数据卷大小增长
- 设置日志轮转避免磁盘满
- 定期清理旧的备份文件

### 4. **版本兼容性**
- 升级容器镜像前备份数据
- 注意数据库版本兼容性
- 测试环境先验证升级流程

## 🆘 故障排除

### 1. **数据卷丢失**
```bash
# 检查数据卷是否存在
docker volume ls | grep hpc

# 如果数据卷丢失，从备份恢复
# 参考上面的恢复数据步骤
```

### 2. **权限问题**
```bash
# 修复PostgreSQL权限
sudo chown -R 999:999 /var/lib/docker/volumes/hpc-user-management_postgres_data/_data

# 修复LDAP权限
sudo chown -R 911:911 /var/lib/docker/volumes/hpc-user-management_ldap_data/_data
```

### 3. **数据损坏**
```bash
# PostgreSQL数据修复
docker exec hpc-postgres pg_dump -U user -d hpc_management --schema-only > schema.sql
# 然后从备份恢复数据

# LDAP数据修复
docker exec hpc-ldap slapindex
```

---

## 📝 总结

您的系统已经正确配置了数据持久化：
- ✅ PostgreSQL数据自动持久化到Docker数据卷
- ✅ LDAP数据和配置自动持久化到Docker数据卷  
- ✅ 容器停止/重启不会丢失数据
- ✅ 支持备份和恢复操作

**当前数据状态:**
- PI用户: 2个
- 学生用户: 1个
- 数据卷位置: `/var/lib/docker/volumes/hpc-user-management_*`

只要不删除Docker数据卷，您的数据就会永久保持！