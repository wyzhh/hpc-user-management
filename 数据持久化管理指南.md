# Dockeræ•°æ®æŒä¹…åŒ–ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•åœ¨Dockerå®¹å™¨åœæ­¢/é‡å¯åä¿æŒæ•°æ®è¡¨çš„æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬PostgreSQLæ•°æ®åº“å’ŒLDAPç›®å½•æœåŠ¡çš„æ•°æ®ä¿æŠ¤ã€‚

## âœ… å½“å‰æŒä¹…åŒ–é…ç½®

### 1. **æ•°æ®å·é…ç½®** (docker-compose.yml)
```yaml
volumes:
  postgres_data:
    driver: local      # PostgreSQLæ•°æ®æŒä¹…åŒ–
  ldap_data:
    driver: local      # LDAPæ•°æ®æŒä¹…åŒ–  
  ldap_config:
    driver: local      # LDAPé…ç½®æŒä¹…åŒ–
```

### 2. **å®¹å™¨æŒ‚è½½é…ç½®**
```yaml
# PostgreSQLå®¹å™¨
db:
  volumes:
    - postgres_data:/var/lib/postgresql/data          # æ•°æ®åº“æ–‡ä»¶
    - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql  # åˆå§‹åŒ–è„šæœ¬

# LDAPå®¹å™¨  
ldap:
  volumes:
    - ldap_data:/var/lib/ldap                         # LDAPæ•°æ®æ–‡ä»¶
    - ldap_config:/etc/ldap/slapd.d                   # LDAPé…ç½®æ–‡ä»¶
    - ./database/ldap-init.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/init.ldif
```

## ğŸ” éªŒè¯æ•°æ®æŒä¹…åŒ–

### 1. **æ£€æŸ¥æ•°æ®å·çŠ¶æ€**
```bash
# æŸ¥çœ‹æ‰€æœ‰æ•°æ®å·
docker volume ls | grep hpc

# æ£€æŸ¥PostgreSQLæ•°æ®å·è¯¦æƒ…
docker volume inspect hpc-user-management_postgres_data

# æ£€æŸ¥LDAPæ•°æ®å·è¯¦æƒ…  
docker volume inspect hpc-user-management_ldap_data
```

### 2. **æŸ¥çœ‹æ•°æ®å·å­˜å‚¨ä½ç½®**
```bash
# PostgreSQLæ•°æ®ä½ç½®
sudo ls -la /var/lib/docker/volumes/hpc-user-management_postgres_data/_data/

# LDAPæ•°æ®ä½ç½®
sudo ls -la /var/lib/docker/volumes/hpc-user-management_ldap_data/_data/

# LDAPé…ç½®ä½ç½®
sudo ls -la /var/lib/docker/volumes/hpc-user-management_ldap_config/_data/
```

### 3. **æµ‹è¯•æŒä¹…åŒ–åŠŸèƒ½**
```bash
# 1. è®°å½•å½“å‰æ•°æ®
docker exec hpc-postgres psql -U user -d hpc_management -c "SELECT COUNT(*) FROM pis;"
docker exec hpc-ldap ldapsearch -x -H ldap://localhost:389 -D "cn=admin,dc=hpc,dc=university,dc=edu" -w admin_password -b "dc=hpc,dc=university,dc=edu" "(objectClass=person)" | grep "numEntries"

# 2. åœæ­¢å®¹å™¨
docker-compose stop db ldap

# 3. å¯åŠ¨å®¹å™¨
docker-compose up -d db ldap

# 4. éªŒè¯æ•°æ®æ˜¯å¦ä¿æŒ
docker exec hpc-postgres psql -U user -d hpc_management -c "SELECT COUNT(*) FROM pis;"
```

## ğŸ› ï¸ æ•°æ®ç®¡ç†æ“ä½œ

### 1. **å¤‡ä»½æ•°æ®**

#### PostgreSQLå¤‡ä»½
```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ./backups

# å¤‡ä»½æ•°æ®åº“
docker exec hpc-postgres pg_dump -U user -d hpc_management > ./backups/hpc_database_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½æ•°æ®å·
sudo tar -czf ./backups/postgres_volume_$(date +%Y%m%d_%H%M%S).tar.gz -C /var/lib/docker/volumes/hpc-user-management_postgres_data _data
```

#### LDAPå¤‡ä»½
```bash
# å¤‡ä»½LDAPæ•°æ®
docker exec hpc-ldap slapcat > ./backups/ldap_data_$(date +%Y%m%d_%H%M%S).ldif

# å¤‡ä»½LDAPæ•°æ®å·
sudo tar -czf ./backups/ldap_volume_$(date +%Y%m%d_%H%M%S).tar.gz -C /var/lib/docker/volumes/hpc-user-management_ldap_data _data
```

### 2. **æ¢å¤æ•°æ®**

#### PostgreSQLæ¢å¤
```bash
# ä»SQLæ–‡ä»¶æ¢å¤
docker exec -i hpc-postgres psql -U user -d hpc_management < ./backups/hpc_database_YYYYMMDD_HHMMSS.sql

# ä»æ•°æ®å·æ¢å¤
docker-compose stop db
sudo rm -rf /var/lib/docker/volumes/hpc-user-management_postgres_data/_data/*
sudo tar -xzf ./backups/postgres_volume_YYYYMMDD_HHMMSS.tar.gz -C /var/lib/docker/volumes/hpc-user-management_postgres_data/
docker-compose up -d db
```

#### LDAPæ¢å¤
```bash
# ä»LDIFæ–‡ä»¶æ¢å¤
docker exec hpc-ldap slapadd -c -l /path/to/backup.ldif

# ä»æ•°æ®å·æ¢å¤
docker-compose stop ldap
sudo rm -rf /var/lib/docker/volumes/hpc-user-management_ldap_data/_data/*
sudo tar -xzf ./backups/ldap_volume_YYYYMMDD_HHMMSS.tar.gz -C /var/lib/docker/volumes/hpc-user-management_ldap_data/
docker-compose up -d ldap
```

### 3. **æ¸…ç†å’Œé‡ç½®**

#### å®Œå…¨é‡ç½®æ•°æ®
```bash
# åœæ­¢æ‰€æœ‰å®¹å™¨
docker-compose down

# åˆ é™¤æ•°æ®å·ï¼ˆè°¨æ…æ“ä½œï¼ï¼‰
docker volume rm hpc-user-management_postgres_data
docker volume rm hpc-user-management_ldap_data
docker volume rm hpc-user-management_ldap_config

# é‡æ–°åˆ›å»ºå¹¶åˆå§‹åŒ–
docker-compose up -d
```

#### ä»…é‡ç½®ç‰¹å®šæœåŠ¡
```bash
# é‡ç½®PostgreSQL
docker-compose stop db
docker volume rm hpc-user-management_postgres_data
docker-compose up -d db

# é‡ç½®LDAP
docker-compose stop ldap  
docker volume rm hpc-user-management_ldap_data hpc-user-management_ldap_config
docker-compose up -d ldap
```

## ğŸ“Š æ•°æ®å·çŠ¶æ€ç›‘æ§

### 1. **æŸ¥çœ‹æ•°æ®å·ä½¿ç”¨æƒ…å†µ**
```bash
# æŸ¥çœ‹æ•°æ®å·å¤§å°
docker system df -v

# æŸ¥çœ‹ç‰¹å®šæ•°æ®å·å¤§å°
sudo du -sh /var/lib/docker/volumes/hpc-user-management_postgres_data/_data
sudo du -sh /var/lib/docker/volumes/hpc-user-management_ldap_data/_data
```

### 2. **ç›‘æ§æ•°æ®å·å¥åº·çŠ¶æ€**
```bash
# æ£€æŸ¥PostgreSQLæ•°æ®å®Œæ•´æ€§
docker exec hpc-postgres pg_isready -U user -d hpc_management

# æ£€æŸ¥LDAPæœåŠ¡çŠ¶æ€
docker exec hpc-ldap ldapsearch -x -H ldap://localhost:389 -s base -b "" "(objectclass=*)" namingContexts
```

## ğŸ”§ é«˜çº§é…ç½®

### 1. **ä½¿ç”¨å¤–éƒ¨å­˜å‚¨è·¯å¾„**

å¦‚æœè¦å°†æ•°æ®å­˜å‚¨åœ¨ç‰¹å®šç›®å½•ï¼Œå¯ä»¥ä¿®æ”¹docker-compose.ymlï¼š

```yaml
services:
  db:
    volumes:
      - ./data/postgres:/var/lib/postgresql/data  # ä½¿ç”¨æœ¬åœ°è·¯å¾„
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql

  ldap:
    volumes:
      - ./data/ldap:/var/lib/ldap                 # ä½¿ç”¨æœ¬åœ°è·¯å¾„
      - ./data/ldap-config:/etc/ldap/slapd.d      # ä½¿ç”¨æœ¬åœ°è·¯å¾„
```

### 2. **è®¾ç½®æ•°æ®å·æƒé™**
```bash
# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p ./data/{postgres,ldap,ldap-config}

# è®¾ç½®æ­£ç¡®çš„æƒé™
sudo chown -R 999:999 ./data/postgres      # PostgreSQLç”¨æˆ·
sudo chown -R 911:911 ./data/ldap          # LDAPç”¨æˆ·  
sudo chown -R 911:911 ./data/ldap-config   # LDAPé…ç½®
```

### 3. **æ•°æ®å·å¤‡ä»½ç­–ç•¥**

#### è‡ªåŠ¨å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="./backups/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# PostgreSQLå¤‡ä»½
echo "å¤‡ä»½PostgreSQLæ•°æ®..."
docker exec hpc-postgres pg_dump -U user -d hpc_management > $BACKUP_DIR/postgres.sql

# LDAPå¤‡ä»½
echo "å¤‡ä»½LDAPæ•°æ®..."  
docker exec hpc-ldap slapcat > $BACKUP_DIR/ldap.ldif

# å‹ç¼©å¤‡ä»½
echo "å‹ç¼©å¤‡ä»½æ–‡ä»¶..."
tar -czf $BACKUP_DIR.tar.gz -C $BACKUP_DIR .
rm -rf $BACKUP_DIR

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR.tar.gz"
```

#### è®¾ç½®å®šæ—¶å¤‡ä»½
```bash
# æ·»åŠ åˆ°crontab (æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½)
echo "0 2 * * * /path/to/hpc-user-management/backup.sh" | crontab -
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **æ•°æ®å®‰å…¨**
- å®šæœŸå¤‡ä»½æ•°æ®å·
- å¤‡ä»½æ–‡ä»¶åº”å­˜å‚¨åœ¨ä¸åŒçš„ç‰©ç†ä½ç½®
- æµ‹è¯•æ¢å¤æµç¨‹çš„æœ‰æ•ˆæ€§

### 2. **æƒé™ç®¡ç†**
- ç¡®ä¿æ•°æ®å·æœ‰æ­£ç¡®çš„æ–‡ä»¶æƒé™
- é¿å…ä½¿ç”¨rootæƒé™è¿è¡Œå®¹å™¨
- å®šæœŸæ£€æŸ¥æ•°æ®ç›®å½•æƒé™

### 3. **å­˜å‚¨ç©ºé—´**
- ç›‘æ§æ•°æ®å·å¤§å°å¢é•¿
- è®¾ç½®æ—¥å¿—è½®è½¬é¿å…ç£ç›˜æ»¡
- å®šæœŸæ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶

### 4. **ç‰ˆæœ¬å…¼å®¹æ€§**
- å‡çº§å®¹å™¨é•œåƒå‰å¤‡ä»½æ•°æ®
- æ³¨æ„æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹æ€§
- æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯å‡çº§æµç¨‹

## ğŸ†˜ æ•…éšœæ’é™¤

### 1. **æ•°æ®å·ä¸¢å¤±**
```bash
# æ£€æŸ¥æ•°æ®å·æ˜¯å¦å­˜åœ¨
docker volume ls | grep hpc

# å¦‚æœæ•°æ®å·ä¸¢å¤±ï¼Œä»å¤‡ä»½æ¢å¤
# å‚è€ƒä¸Šé¢çš„æ¢å¤æ•°æ®æ­¥éª¤
```

### 2. **æƒé™é—®é¢˜**
```bash
# ä¿®å¤PostgreSQLæƒé™
sudo chown -R 999:999 /var/lib/docker/volumes/hpc-user-management_postgres_data/_data

# ä¿®å¤LDAPæƒé™
sudo chown -R 911:911 /var/lib/docker/volumes/hpc-user-management_ldap_data/_data
```

### 3. **æ•°æ®æŸå**
```bash
# PostgreSQLæ•°æ®ä¿®å¤
docker exec hpc-postgres pg_dump -U user -d hpc_management --schema-only > schema.sql
# ç„¶åä»å¤‡ä»½æ¢å¤æ•°æ®

# LDAPæ•°æ®ä¿®å¤
docker exec hpc-ldap slapindex
```

---

## ğŸ“ æ€»ç»“

æ‚¨çš„ç³»ç»Ÿå·²ç»æ­£ç¡®é…ç½®äº†æ•°æ®æŒä¹…åŒ–ï¼š
- âœ… PostgreSQLæ•°æ®è‡ªåŠ¨æŒä¹…åŒ–åˆ°Dockeræ•°æ®å·
- âœ… LDAPæ•°æ®å’Œé…ç½®è‡ªåŠ¨æŒä¹…åŒ–åˆ°Dockeræ•°æ®å·  
- âœ… å®¹å™¨åœæ­¢/é‡å¯ä¸ä¼šä¸¢å¤±æ•°æ®
- âœ… æ”¯æŒå¤‡ä»½å’Œæ¢å¤æ“ä½œ

**å½“å‰æ•°æ®çŠ¶æ€:**
- PIç”¨æˆ·: 2ä¸ª
- å­¦ç”Ÿç”¨æˆ·: 1ä¸ª
- æ•°æ®å·ä½ç½®: `/var/lib/docker/volumes/hpc-user-management_*`

åªè¦ä¸åˆ é™¤Dockeræ•°æ®å·ï¼Œæ‚¨çš„æ•°æ®å°±ä¼šæ°¸ä¹…ä¿æŒï¼