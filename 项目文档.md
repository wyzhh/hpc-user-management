# HPC用户管理系统 - 完整项目文档

## 📋 项目概述

这是一个HPC（高性能计算）用户管理系统，基于LDAP认证和PostgreSQL数据库，支持PI（导师）、学生和管理员三种用户角色，提供完整的用户生命周期管理。

### 技术栈
- **后端**: Node.js + Express + TypeScript
- **前端**: React + TypeScript + Ant Design
- **数据库**: PostgreSQL 15
- **认证**: LDAP + JWT
- **容器化**: Docker + Docker Compose

---

## 🏗️ 系统架构

### 用户角色分层
```
管理员 (Admin)
├── 超级管理员 (super_admin) - 系统最高权限
└── 普通管理员 (admin) - 基础管理权限

PI用户 (Principal Investigators)
├── 管理自己的学生
├── 审批学生申请
└── LDAP认证

学生用户 (Students)  
├── 申请加入PI团队
├── LDAP认证
└── 状态管理 (pending/active/deleted)
```

### 数据流向
```
LDAP服务器 ←→ 后端API ←→ PostgreSQL数据库
     ↑              ↓
   用户认证      前端界面
```

---

## 🗂️ 目录结构

```
hpc-user-management/
├── backend/                    # 后端API服务
│   ├── src/
│   │   ├── config/            # 配置文件
│   │   │   ├── database.ts    # 数据库连接配置
│   │   │   └── index.ts       # 主配置文件
│   │   ├── controllers/       # 控制器层
│   │   │   ├── auth.ts        # 认证控制器
│   │   │   ├── user.ts        # 用户管理控制器
│   │   │   ├── student.ts     # 学生管理控制器
│   │   │   └── request.ts     # 申请管理控制器
│   │   ├── middleware/        # 中间件
│   │   │   ├── auth.ts        # JWT认证中间件
│   │   │   └── validation.ts  # 数据验证中间件
│   │   ├── models/           # 数据模型层
│   │   │   └── index.ts      # 数据库模型定义
│   │   ├── routes/           # 路由定义
│   │   │   ├── auth.ts       # 认证路由
│   │   │   ├── user.ts       # 用户管理路由
│   │   │   ├── student.ts    # 学生管理路由
│   │   │   └── request.ts    # 申请管理路由
│   │   ├── services/         # 业务逻辑层
│   │   │   ├── ldap.ts       # LDAP服务
│   │   │   ├── sync.ts       # 用户同步服务
│   │   │   ├── scheduler.ts  # 定时任务服务
│   │   │   ├── audit.ts      # 审计日志服务
│   │   │   └── auth.ts       # 认证服务
│   │   ├── types/            # TypeScript类型定义
│   │   │   └── index.ts      # 接口和类型定义
│   │   └── index.ts          # 应用入口点
│   ├── .env                  # 环境变量配置
│   ├── .env.example          # 环境变量模板
│   └── package.json          # 依赖管理
├── frontend/                 # 前端React应用
│   ├── src/
│   │   ├── components/       # React组件
│   │   │   ├── auth/         # 认证相关组件
│   │   │   ├── user/         # 用户管理组件
│   │   │   ├── student/      # 学生管理组件
│   │   │   └── request/      # 申请管理组件
│   │   ├── pages/            # 页面组件
│   │   ├── services/         # API服务层
│   │   ├── contexts/         # React Context
│   │   └── types/            # TypeScript类型
│   └── package.json
├── database/                 # 数据库初始化文件
│   ├── init.sql              # 数据库结构初始化
│   └── ldap-init.ldif        # LDAP初始化数据
├── docker-compose.yml        # Docker容器编排
├── LDAP配置指南.md           # LDAP配置说明
├── SYNC_CONFIGURATION.md     # 同步配置说明
└── 项目文档.md               # 本文档
```

---

## 🚀 快速启动

### 1. 启动所有服务
```bash
# 启动Docker容器（数据库和LDAP）
docker-compose up -d db ldap

# 启动后端服务
cd backend
npm install
npm run dev

# 启动前端服务
cd ../frontend  
npm install
npm start
```

### 2. 访问地址
- **前端界面**: http://localhost:3000
- **后端API**: http://localhost:8000/api
- **LDAP管理界面**: http://localhost:8080 (可选)

### 3. 默认登录账户
- **管理员**: admin / admin123
- **PI用户**: pi001 / pi001 (LDAP认证)
- **学生用户**: wyuzhan / (LDAP认证)

---

## 🔧 核心功能模块

### 1. 用户认证系统
- **LDAP集成**: 支持PI用户和学生的LDAP认证
- **本地认证**: 管理员账户使用本地密码认证
- **JWT令牌**: 基于Token的会话管理
- **权限控制**: 基于角色的访问控制(RBAC)

### 2. 用户管理
#### PI用户管理
- 从LDAP自动同步用户信息
- 支持用户状态切换(活跃/停用)
- 查看管理的学生列表
- 支持搜索和分页

#### 学生用户管理  
- 学生申请加入PI团队
- PI审批学生申请
- 学生状态管理(待审核/活跃/已删除)
- 支持批量操作

#### 管理员管理
- 创建和管理系统管理员
- 密码重置功能
- 权限分级管理

### 3. LDAP同步系统
#### 同步策略
- **完全同步**: 每天凌晨2点自动执行
- **增量同步**: 每10分钟自动执行  
- **启动同步**: 系统启动后1秒执行
- **手动同步**: 管理界面手动触发

#### 同步功能
- PI用户信息同步
- 学生用户信息同步
- 用户状态自动管理
- 详细的同步结果报告

### 4. 申请管理系统
- 学生申请加入PI团队
- PI审批/拒绝申请
- 申请状态跟踪
- 邮件通知(可配置)

### 5. 审计日志系统
- 记录所有关键操作
- 用户登录日志
- 数据变更追踪
- 系统操作记录

---

## 📊 数据库设计

### 核心表结构

#### PI用户表 (pis)
```sql
CREATE TABLE pis (
    id SERIAL PRIMARY KEY,
    ldap_dn VARCHAR(255),
    username VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(200) NOT NULL,
    email VARCHAR(255) NOT NULL,
    department VARCHAR(200),
    phone VARCHAR(50),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 学生表 (students)
```sql
CREATE TABLE students (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    chinese_name VARCHAR(200) NOT NULL,
    email VARCHAR(255) NOT NULL,
    phone VARCHAR(50),
    pi_id INTEGER REFERENCES pis(id),
    ldap_dn VARCHAR(255),
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 管理员表 (admins)
```sql
CREATE TABLE admins (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(200) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255),
    role VARCHAR(50) DEFAULT 'admin',
    ldap_dn VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 申请表 (requests)
```sql
CREATE TABLE requests (
    id SERIAL PRIMARY KEY,
    student_id INTEGER REFERENCES students(id),
    pi_id INTEGER REFERENCES pis(id),
    reason TEXT,
    status VARCHAR(20) DEFAULT 'pending',
    reviewed_by INTEGER REFERENCES pis(id),
    reviewed_at TIMESTAMP,
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## ⚙️ 配置管理

### 环境变量配置 (.env)
```bash
# 数据库配置
DATABASE_URL=postgresql://user:password@127.0.0.1:5433/hpc_management

# LDAP配置
LDAP_URL=ldap://127.0.0.1:389
LDAP_BIND_DN=cn=admin,dc=hpc,dc=university,dc=edu
LDAP_BIND_PASSWORD=admin_password
LDAP_BASE_DN=dc=hpc,dc=university,dc=edu
LDAP_PI_OU=ou=pis
LDAP_STUDENT_OU=ou=students

# JWT配置
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=8h
JWT_ISSUER=hpc-user-management

# 应用配置
NODE_ENV=development
PORT=8000
FRONTEND_URL=http://10.3.244.110:3000

# 同步配置
SYNC_ON_STARTUP=true  # 启动时是否同步
```

### Docker配置
- **PostgreSQL**: 端口5433，包含初始化SQL
- **OpenLDAP**: 端口389，包含示例用户数据
- **phpLDAPadmin**: 端口8080，LDAP管理界面

---

## 🔄 LDAP同步详解

### 同步时机
1. **启动时立即同步**: 项目启动后1秒执行完全同步
2. **定时增量同步**: 每10分钟执行一次
3. **定时完全同步**: 每天凌晨2点执行
4. **手动同步**: 用户界面手动触发

### 同步逻辑
```typescript
// 完全同步流程
1. 从LDAP获取所有PI用户和学生用户
2. 与数据库现有数据比对
3. 创建新用户/更新现有用户/标记删除用户
4. 记录详细同步结果和审计日志
```

### 同步结果示例
```json
{
  "pis": {
    "total": 2,
    "created": 1,
    "updated": 1,
    "deactivated": 0
  },
  "students": {
    "total": 1,
    "created": 0,
    "updated": 1,
    "deleted": 0
  },
  "errors": []
}
```

---

## 🎯 API接口说明

### 认证接口
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/profile` - 获取用户信息

### 用户管理接口
- `GET /api/admin/users/pis` - 获取PI用户列表
- `GET /api/admin/users/students` - 获取学生用户列表
- `POST /api/admin/users/sync-ldap` - 完全同步LDAP
- `POST /api/admin/users/sync-ldap-incremental` - 增量同步LDAP

### 学生管理接口
- `POST /api/students` - 创建学生账户
- `PUT /api/students/:id` - 更新学生信息
- `DELETE /api/students/:id` - 删除学生账户

### 申请管理接口
- `GET /api/requests` - 获取申请列表
- `POST /api/requests` - 提交申请
- `PUT /api/requests/:id/approve` - 审批申请
- `PUT /api/requests/:id/reject` - 拒绝申请

---

## 🛠️ 开发调试

### 常用命令
```bash
# 后端开发
cd backend
npm run dev          # 启动开发服务器
npm run build        # 构建项目
npm run test         # 运行测试

# 前端开发  
cd frontend
npm start            # 启动开发服务器
npm run build        # 构建生产版本
npm test             # 运行测试

# 数据库操作
docker exec hpc-postgres psql -U user -d hpc_management -c "SELECT * FROM pis;"

# LDAP查询
docker exec hpc-ldap ldapsearch -x -H ldap://localhost:389 -D "cn=admin,dc=hpc,dc=university,dc=edu" -w admin_password -b "dc=hpc,dc=university,dc=edu" "(objectClass=person)"
```

### 日志查看
```bash
# 后端日志 (开发模式直接在终端显示)
# Docker容器日志
docker logs hpc-postgres
docker logs hpc-ldap

# 应用访问日志格式
API请求: {"method":"GET","url":"/users","status":200,"duration":"5ms","user":"admin:admin","ip":"127.0.0.1"}
```

---

## 🔧 故障排除

### 常见问题

#### 1. LDAP连接失败
```bash
# 检查LDAP容器状态
docker ps | grep ldap
# 测试LDAP连接
docker exec hpc-ldap ldapsearch -x -H ldap://localhost:389 -D "cn=admin,dc=hpc,dc=university,dc=edu" -w admin_password -b "dc=hpc,dc=university,dc=edu"
```

#### 2. 数据库连接问题
```bash
# 检查数据库容器
docker ps | grep postgres
# 测试数据库连接
docker exec hpc-postgres psql -U user -d hpc_management -c "SELECT 1;"
```

#### 3. 同步功能异常
- 检查LDAP服务状态
- 查看后端日志错误信息
- 验证环境变量配置
- 手动触发同步测试

#### 4. 前端页面错误
- 检查后端API是否正常响应
- 查看浏览器开发者工具控制台
- 验证API接口返回数据格式

---

## 📈 系统监控

### 关键指标
- **用户数量**: PI用户、学生用户、管理员数量
- **同步状态**: 最后同步时间、同步成功率
- **申请处理**: 待处理申请数量、处理效率
- **系统性能**: API响应时间、数据库连接状态

### 监控方法
- 查看用户统计接口: `GET /api/admin/users/stats`
- 检查审计日志: `GET /api/admin/audit-logs`
- 监控同步任务执行日志
- 定期备份数据库数据

---

## 📚 扩展开发

### 添加新功能的步骤
1. **后端**: 定义类型 → 创建模型 → 实现服务 → 添加控制器 → 配置路由
2. **前端**: 定义接口 → 创建服务 → 实现组件 → 添加页面 → 配置路由
3. **数据库**: 设计表结构 → 添加迁移脚本 → 更新模型定义

### 代码规范
- 使用TypeScript严格模式
- 遵循ESLint和Prettier配置
- API接口统一返回格式
- 组件采用函数式写法
- 数据库操作使用事务

---

## 🔐 安全注意事项

### 认证安全
- JWT密钥使用强随机字符串
- LDAP连接使用专用服务账号
- 密码采用bcrypt加密存储

### 数据安全
- 定期备份数据库
- 敏感信息不记录在日志中
- API接口实施权限控制

### 网络安全
- 生产环境使用HTTPS
- 配置CORS策略
- 限制API访问频率

---

## 📞 维护联系

当遇到问题时：
1. 首先查看本文档的故障排除部分
2. 检查系统日志和错误信息
3. 查看相关配置文件
4. 测试各个组件的连通性

**重要文件位置**:
- 主配置: `backend/src/config/index.ts`
- 环境变量: `backend/.env`
- LDAP配置: `LDAP配置指南.md`
- 同步配置: `SYNC_CONFIGURATION.md`

---

*最后更新: 2025-07-12*
*版本: v1.0*